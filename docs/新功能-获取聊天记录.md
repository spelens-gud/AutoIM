# 新功能：获取聊天记录

## 功能概述

本次更新为旺旺 RPA 系统添加了获取聊天记录的功能，允许用户通过代码或 API 接口获取与指定联系人的历史聊天消息。

## 主要特性

### 1. 核心功能

- ✅ 获取与指定联系人的完整聊天记录
- ✅ 支持限制获取的消息数量（1-500条）
- ✅ 自动滚动加载历史消息
- ✅ 自动识别消息方向（发送/接收）
- ✅ 支持多种消息类型（文本/图片/系统消息）
- ✅ 按时间顺序返回消息（从旧到新）

### 2. API 接口

- ✅ RESTful API 接口：`GET /api/message/history/<contact_id>`
- ✅ 支持 URL 参数配置
- ✅ 完善的错误处理
- ✅ 标准 JSON 响应格式

### 3. 文档和示例

- ✅ 完整的功能说明文档
- ✅ API 使用指南
- ✅ Python、JavaScript、Shell 等多种语言示例
- ✅ 交互式测试脚本

## 快速开始

### 方式一：直接使用 Python API

```python
from src.core.browser_controller import BrowserController
from src.core.message_handler import MessageHandler

# 初始化
browser = BrowserController(headless=False)
browser.navigate_to("https://work.1688.com/")
message_handler = MessageHandler(browser)

# 获取聊天记录
messages = message_handler.get_chat_messages(
    contact_id="某某旗舰店",
    max_messages=50
)

# 显示消息
for msg in messages:
    sender = "我" if msg.is_sent else msg.contact_name
    print(f"{sender}: {msg.content}")
```

### 方式二：使用 HTTP API

```bash
# 1. 启动 API 服务
python api_server.py --auto-start

# 2. 调用 API 获取聊天记录
curl "http://localhost:5001/api/message/history/某某旗舰店?max_messages=50"
```

### 方式三：使用测试脚本

```bash
# 运行交互式测试脚本
python test_api_chat_history.py
```

## 使用场景

1. **客服记录查询**: 快速查看与客户的历史对话记录
2. **数据分析**: 导出聊天记录进行数据分析和统计
3. **问题追溯**: 查找历史消息中的关键信息
4. **自动化备份**: 定期备份重要客户的聊天记录
5. **质量监控**: 检查客服回复质量和响应时间

## 技术实现

### 核心方法

#### `get_chat_messages(contact_id, max_messages=100)`

获取与指定联系人的聊天消息列表。

**参数**:
- `contact_id` (str): 联系人ID或联系人名称
- `max_messages` (int): 最多获取的消息数量，默认100

**返回**:
- `List[Message]`: 消息对象列表

**异常**:
- `MessageException`: 当获取消息失败时抛出

### 实现细节

1. **iframe 切换**: 自动切换到旺旺聊天 iframe
2. **联系人定位**: 使用多种策略定位目标联系人
3. **消息加载**: 自动滚动加载历史消息
4. **消息解析**: 提取消息内容、时间、发送者等信息
5. **方向识别**: 通过 CSS 类名和样式判断消息方向

## API 接口详情

### 请求

```
GET /api/message/history/<contact_id>?max_messages=50
```

### 响应

```json
{
  "success": true,
  "data": {
    "contact_id": "某某旗舰店",
    "count": 15,
    "messages": [
      {
        "message_id": "msg_001",
        "contact_id": "shop_123",
        "contact_name": "某某旗舰店",
        "content": "你好，请问有货吗？",
        "message_type": "text",
        "timestamp": "2025-11-26T18:50:00",
        "is_sent": true,
        "is_auto_reply": false
      }
    ]
  }
}
```

## 测试覆盖

- ✅ 成功获取聊天消息
- ✅ 空消息列表处理
- ✅ 消息数量限制
- ✅ 切换聊天窗口失败
- ✅ iframe 未找到
- ✅ 发送消息解析
- ✅ 接收消息解析
- ✅ 图片消息识别

## 文件清单

### 核心代码
- `src/core/message_handler.py` - 添加 `get_chat_messages()` 和 `_parse_chat_message_element()` 方法

### API 服务
- `api_server.py` - 添加 `/api/message/history/<contact_id>` 接口

### 测试文件
- `tests/test_message_handler.py` - 添加单元测试
- `test_get_messages.py` - 功能测试脚本
- `test_api_chat_history.py` - API 测试脚本

### 文档
- `docs/获取聊天消息功能说明.md` - 功能详细说明
- `docs/API使用指南-获取聊天记录.md` - API 使用指南
- `API.md` - 更新 API 文档
- `CHANGELOG.md` - 更新变更日志

## 注意事项

1. **执行时间**: 获取大量历史消息可能需要 10-30 秒
2. **浏览器状态**: 该功能会切换到指定联系人的聊天窗口
3. **消息数量**: 建议根据实际需求设置合理的 `max_messages` 值
4. **网络状况**: 需要稳定的网络连接
5. **登录状态**: 确保已登录旺旺账号

## 性能建议

- 首次获取建议限制在 50-100 条消息
- 对于频繁访问的联系人，可以在客户端缓存结果
- 批量获取多个联系人的记录时，建议串行处理
- 设置合理的超时时间（建议 60 秒）

## 后续计划

- [ ] 支持按时间范围筛选消息
- [ ] 支持按消息类型筛选
- [ ] 支持关键词搜索
- [ ] 支持导出为多种格式（CSV、Excel、PDF）
- [ ] 添加消息统计分析功能
- [ ] 支持批量获取多个联系人的聊天记录

## 反馈和支持

如有问题或建议，请通过以下方式联系：

- 提交 Issue
- 查看文档：`docs/` 目录
- 运行测试脚本：`python test_api_chat_history.py`

## 版本信息

- **添加日期**: 2025-11-26
- **版本**: unreleased
- **兼容性**: Python 3.9+
